<!-- recommendation.component.html -->
<div class="container mt-4">
  <h2 class="mb-3">Recommendation List</h2>
  <button class="btn btn-primary mb-3" (click)="openModal()">+ Create Recommendation</button>

  <table class="table table-bordered">
    <thead>
      <tr>
        <th>Batch</th>
        <th>Trainee</th>
        <th>Instructor</th>
        <th>Recommendation</th>
        <th>Date</th>
        <th>Status</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let rec of recommendations | paginate: { itemsPerPage: itemsPerPage, currentPage: p }">
        <td>{{ rec.batchName }}</td>
        <td>{{ rec.traineeName }}</td>
        <td>{{ rec.instructorName }}</td>
        <td>{{ rec.recommendationText }}</td>
        <td>{{ rec.recommendationDate | date }}</td>
        <td>{{ rec.recommendationStatus }}</td>
        <td>
          <button class="btn btn-sm btn-info me-2" (click)="openDetailsModal(rec.recommendationId)">Detail</button>
          <button class="btn btn-sm btn-warning me-2" (click)="openEditModal(rec.recommendationId)">Edit</button>
          <button class="btn btn-sm btn-danger" (click)="onDelete(rec)">Delete</button>
        </td>
      </tr>
    </tbody>
  </table>

  <pagination-controls (pageChange)="p = $event"></pagination-controls>

  <!-- Modal -->
  <div class="modal" [class.show]="showModal" tabindex="-1" style="display: block;" *ngIf="showModal">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Create Recommendation</h5>
          <button type="button" class="btn-close" (click)="closeModal()"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label>Batch</label>
            <select class="form-select" [(ngModel)]="selectedBatchId" (change)="onBatchChanged(selectedBatchId!)">
              <option [ngValue]="null">-- Select Batch --</option>
              <option *ngFor="let b of batches" [ngValue]="b.batchId">{{ b.batchName }}</option>
            </select>
          </div>

          <div *ngIf="selectedInstructorName" class="mb-3">
            <label>Instructor</label>
            <input type="text" class="form-control" [value]="selectedInstructorName" readonly>
          </div>

          <div *ngIf="recommendationEntries.length > 0" style="max-height: 400px; overflow-y: auto;" class="border p-2 rounded bg-light">
            <div *ngFor="let entry of recommendationEntries; let i = index" class="border rounded p-3 mb-3 bg-white">
              <h6>{{ entry.traineeName }} </h6>

              <div class="row">
                <!-- Assessment dropdown -->
                <div class="col-md-4">
                  <label>Assessment</label>
                  <select class="form-select" [(ngModel)]="entry.assessmentId" [disabled]="entry.assessments.length === 0">
                    <option [ngValue]="null">
                      {{ entry.assessments.length === 0 ? 'No assessments available' : '-- Select Assessment --' }}
                    </option>
                    <option *ngFor="let a of entry.assessments"
                            [ngValue]="a.isFinalized ? a.assessmentId : null"
                            [disabled]="!a.isFinalized">
                      {{ getAssessmentStatusText(a) }}
                    </option>
                  </select>
                </div>

                <!-- Invoice dropdown -->
                <div class="col-md-4">
                  <label>Invoice</label>
                  <div class="input-group">
                    <select class="form-select" [(ngModel)]="entry.invoiceId">

                      <option *ngFor="let inv of entry.invoices"
                              [ngValue]="inv.invoiceId"
                              [disabled]="!isPaymentCleared(entry)">
                        {{ getInvoiceStatusText(entry) }}
                      </option>
                    </select>
                    <span class="input-group-text" [ngClass]="getStatusBadgeClass(entry)">
                      {{ entry.paymentSummary?.statusMessage || 'N/A' }}
                    </span>
                  </div>
                </div>

                <!-- Status dropdown -->
                <div class="col-md-4">
                  <label>Status</label>
                  <select class="form-select" [(ngModel)]="entry.recommendationStatus">
                    <option *ngFor="let status of recommendationStatuses" [ngValue]="status.value">
                      {{ status.display }}
                    </option>
                  </select>
                </div>
              </div>

              <!-- Recommendation text and date -->
              <div class="mt-3">
                <label>Recommendation Text</label>
                <textarea class="form-control" [(ngModel)]="entry.recommendationText" rows="2"></textarea>
              </div>

              <div class="mt-2">
                <label>Date</label>
                <input type="date" class="form-control" [(ngModel)]="entry.recommendationDate">
              </div>
            </div>
          </div>
          <div *ngIf="recommendationEntries.length === 0" class="text-muted">No trainees found for this batch.</div>
        </div>

        <div class="modal-footer">
          <button class="btn btn-secondary" (click)="closeModal()">Close</button>
          <button class="btn btn-success" (click)="submitRecommendations()" [disabled]="!recommendationEntries.length">Submit</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Details Modal -->
<div class="modal" [class.show]="showDetailsModal" tabindex="-1" style="display: block;" *ngIf="showDetailsModal">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title">Recommendation Details</h5>
        <button type="button" class="btn-close btn-close-white" (click)="showDetailsModal = false"></button>
      </div>
      <div class="modal-body" *ngIf="selectedRecommendation">
        <div class="row mb-3">
          
          <div class="col-md-4">
            <strong>Date:</strong> {{ selectedRecommendation.recommendationDate  }}
          </div>
          <div class="col-md-4">
            <strong>Status:</strong>
            <span class="badge" [ngClass]="{
              'bg-success': selectedRecommendation.recommendationStatus === 'approved',
              'bg-warning': selectedRecommendation.recommendationStatus === 'pending',
              'bg-danger': selectedRecommendation.recommendationStatus === 'rejected'
            }">
              {{ selectedRecommendation.recommendationStatus | titlecase }}
            </span>
          </div>
        </div>

        <div class="card mb-3">
          <div class="card-header bg-light">
            <h6 class="mb-0">Batch Information</h6>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-6">
                <strong>Batch Name:</strong> {{ selectedRecommendation.batch?.batchName || 'N/A' }}
              </div>

            </div>
          </div>
        </div>

        <div class="card mb-3">
          <div class="card-header bg-light">
            <h6 class="mb-0">Trainee Information</h6>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-6">
                <strong>Trainee Name:</strong> {{ selectedRecommendation.trainee?.registration?.traineeName || 'N/A' }}
              </div>
              <div class="col-md-6">
                <strong>Trainee ID No:</strong> {{ selectedRecommendation.trainee?.TraineeIDNo || 'N/A' }}
              </div>

            </div>
          </div>
        </div>

        <div class="card mb-3">
          <div class="card-header bg-light">
            <h6 class="mb-0">Instructor Information</h6>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-6">
                <strong>Instructor Name:</strong> {{ selectedRecommendation.instructor?.employee?.employeeName || 'N/A' }}
              </div>

            </div>
          </div>
        </div>

        <div class="card mb-3">
          <div class="card-header bg-light">
            <h6 class="mb-0">Assessment Information</h6>
          </div>
          <div class="card-body">
            <div class="row">

              <div class="col-md-4">
                <strong>Type:</strong> {{ selectedRecommendation.assessment?.assessmentType || 'N/A' }}
              </div>
              <div class="col-md-4">
                <strong>Finalized:</strong>
                <span class="badge" [ngClass]="{
                  'bg-success': selectedRecommendation.assessment?.isFinalized,
                  'bg-danger': !selectedRecommendation.assessment?.isFinalized
                }">
                  {{ selectedRecommendation.assessment?.isFinalized ? 'Yes' : 'No' }}
                </span>
              </div>
            </div>
            <div class="row mt-2">
              <div class="col-md-4">
                <strong>Date:</strong> {{ selectedRecommendation.assessment?.assessmentDate  || 'N/A' }}
              </div>
            
              
            </div>
          </div>
        </div>

        <div class="card mb-3">
          <div class="card-header bg-light">
            <h6 class="mb-0">Invoice Information</h6>
          </div>
          <div class="card-body">
            <div class="row">

              <div class="col-md-4">
                <strong>Invoice No:</strong> {{ selectedRecommendation.invoice?.invoiceNo || 'N/A' }}
              </div>
              
            </div>
            
          </div>
        </div>

        <div class="card">
          <div class="card-header bg-light">
            <h6 class="mb-0">Recommendation Text</h6>
          </div>
          <div class="card-body">
            <p class="mb-0">{{ selectedRecommendation.recommendationText }}</p>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" (click)="showDetailsModal = false">Close</button>
      </div>
    </div>
  </div>
</div>
<!-- Edit Modal -->
<div class="modal" [class.show]="showEditModal" tabindex="-1" style="display: block;" *ngIf="showEditModal">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-warning">
        <h5 class="modal-title">Edit Recommendation</h5>
        <button type="button" class="btn-close" (click)="showEditModal = false"></button>
      </div>
      <div class="modal-body" *ngIf="selectedEditRecommendation">
        <div class="mb-3">
          <label>Trainee</label>
          <input class="form-control"
                 [value]="selectedEditRecommendation.trainee?.registration?.traineeName +
                         ' (' + selectedEditRecommendation.trainee?.TraineeIDNo + ')'"
                 readonly>
        </div>
        <div class="mb-3">
          <label>Batch Name</label>
          <input type="text" class="form-control" [value]="selectedEditRecommendation?.batch?.batchName" readonly>
        </div>

        <div class="mb-3">
          <label>Instructor Name</label>
          <input type="text" class="form-control" [value]="selectedEditRecommendation?.instructor?.employee?.employeeName" readonly>
        </div>



        <div class="mb-3">
          <label>Recommendation Date</label>
          <input type="date" class="form-control" [(ngModel)]="selectedEditRecommendation.recommendationDate">
        </div>

        <div class="mb-3">
          <label>Recommendation Text</label>
          <textarea class="form-control" rows="3" [(ngModel)]="selectedEditRecommendation.recommendationText"></textarea>
        </div>

        <div class="mb-3">
          <label>Status</label>
          <select class="form-select" [(ngModel)]="selectedEditRecommendation.recommendationStatus">
            <option *ngFor="let status of recommendationStatuses" [ngValue]="status.value">{{ status.display }}</option>
          </select>
        </div>

        <div class="mb-3">
          <label>Assessment Finalized</label>
          <input class="form-control" [value]="selectedEditRecommendation.assessment?.isFinalized ? 'Yes' : 'No'" readonly>
        </div>

        <div class="mb-3">
          <label>Invoice No</label>
          <input class="form-control" [value]="selectedEditRecommendation.invoice?.invoiceNo" readonly>
        </div>

      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" (click)="showEditModal = false">Cancel</button>
        <button class="btn btn-primary" (click)="submitEditRecommendation()">Update</button>
      </div>
    </div>
  </div>
</div>
